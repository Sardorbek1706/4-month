generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  USER 
  ADMIN
  SUPERADMIN
}

enum SubscriptionStatus {
  ACTIVE 
  EXPIRED
  CANELED
  PENDING_PAYMENT
}

enum PaymentMethod {
  CARD 
  PAYPAL
  BANK_TRANSFER
  CRYPTO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionType {
  free 
  premium
}

enum Quality {
  p240
  p360
  p480
  p720
  p1080
  K4
}


model Users {
  id         String   @id @default(uuid())
  username   String   @unique
  email      String   @unique
  password   String
  role       Role     @default(USER)
  awatar_url String?
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updated_at DateTime @updatedAt 

  profile        Profile?
  subscriptions  User_subscriptions[]
  favorites      Favorites[]
  reviews        Reviews[]
  watch_history  Watch_history[]
  @@map("users")
}



model Profile {
  id        String @id @default(uuid())
  userId    String @unique
  full_name  String
  phone     String
  country   String
  createdAt DateTime @default(now())
  updated_at DateTime @updatedAt

  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("profiles")
}


model Subscription_plans {
  id           String  @id @default(uuid())
  name         String
  price        Decimal
  duration_days Int
  is_active     Boolean @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  subscriptions User_subscriptions[]
  @@map("subscription_plans")
}

model User_subscriptions {
  id        String @id @default(uuid())
  userId    String
  planId    String
  start_date DateTime @default(now())
  end_date   DateTime? 
  status    SubscriptionStatus @default(PENDING_PAYMENT)
  auto_renew Boolean @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user    Users             @relation(fields: [userId], references: [id])
  plan    Subscription_plans @relation(fields: [planId], references: [id])
  payment Payment?
  @@map("user_subscriptions")
}

model Payment {
  id                   String @id @default(uuid())
  user_subscriptionId   String @unique
  amount               Decimal
  paymentMethod        PaymentMethod
  payment_details      Json
  status               PaymentStatus
  externalTransactionId String?
  createdAt DateTime @default(now())
  updated_at DateTime @updatedAt

  subscription User_subscriptions @relation(fields: [user_subscriptionId], references: [id])
  @@map("payments")
}

model Categories {
  id          String @id @default(uuid())
  name        String
  slug        String @unique
  description String?
  created_at  DateTime @default(now())
  updated_at DateTime @updatedAt

  movies Movie_categories[]
  @@map("categories")
}

model Movies {
  id               String @id @default(uuid())
  title            String
  slug             String @unique
  description      String
  release_year      Int
  duration_minutes  Int
  poster_url        String
  subscription_type SubscriptionType @default(free)
  price             Int @default(0)
  view_count        Int @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  categories Movie_categories[]
  files      Movie_files[]
  favorites  Favorites[]
  reviews    Reviews[]
  history    Watch_history[]
  @@map("movies")
}

model Movie_categories {
  id         String @id @default(uuid())
  movieId    String
  categoryId String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  movie    Movies    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  category Categories @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  @@unique([movieId, categoryId])
  @@map("movie_categories")
}

model Movie_files {
  id       String @id @default(uuid())
  movieId  String
  file_url  String
  quality  Quality
  language String @default("uz")

  movie Movies @relation(fields: [movieId], references: [id], onDelete: Cascade)
  @@map("movie_files")
}

model Favorites {
  id      String @id @default(uuid())
  userId  String
  movieId String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user  Users  @relation(fields: [userId], references: [id])
  movie Movies @relation(fields: [movieId], references: [id])
  @@unique([userId, movieId])
  @@map("favorites")
}

model Reviews {
  id      String @id @default(uuid())
  userId  String
  movieId String
  rating  Int
  comment String? 
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user  Users  @relation(fields: [userId], references: [id])
  movie Movies @relation(fields: [movieId], references: [id])
  @@map("reviews")
}

model Watch_history {
  id               String @id @default(uuid())
  userId           String
  movieId          String
  watched_duration Int
  last_watched     DateTime @default(now())
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user  Users  @relation(fields: [userId], references: [id])
  movie Movies @relation(fields: [movieId], references: [id])
  @@map("watch_history")
}
